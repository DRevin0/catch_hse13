#!/bin/bash
#!/bin/bash

CURRENT_DIR="$(pwd)"
TEST_LOG_DIR="$CURRENT_DIR/test"
BACKUP_DIR="$CURRENT_DIR/backup"
SCRIPT_PATH="./arscript"

#тестовая папка если не существует
mkdir -p "$TEST_LOG_DIR"
mkdir -p "$BACKUP_DIR"

#очистка перед началом
echo "Очищаем тестовую папку..."
rm -f "$TEST_LOG_DIR"/*
rm -f "$BACKUP_DIR"/*

#создание файлов
echo "Создаем тестовые файлы общим размером ~0.5GB..."
cd "$TEST_LOG_DIR"

#создаем 2500 файлов по 200KB = 500MB (0.5GB)
for i in {1..2500}; do
    dd if=/dev/zero of="file_$i.txt" bs=200K count=1 status=none
done

echo "Тестовые файлы созданы. Общий размер:"
du -sh "$TEST_LOG_DIR"

#возвращаемся в исходную директорию
cd - > /dev/null

echo "========================================"
echo "Тест 1: Проверка с порогом 70%"
"$SCRIPT_PATH" -f "$TEST_LOG_DIR" -b "$BACKUP_DIR" -t 70

echo "========================================"
echo "Тест 2: Проверка с порогом 25%"
"$SCRIPT_PATH" -f "$TEST_LOG_DIR" -b "$BACKUP_DIR" -t 55

echo "========================================"
echo "Тест 3: Проверка с порогом 3%"
"$SCRIPT_PATH" -f "$TEST_LOG_DIR" -b "$BACKUP_DIR" -t 20

echo "========================================"
echo "Тест 4: Проверка с порогом 10%"
"$SCRIPT_PATH" -f "$TEST_LOG_DIR" -b "$BACKUP_DIR" -t 10

echo "========================================"
echo "Все тесты завершены"
echo "Проверьте архивы в: $BACKUP_DIR"
echo "Остаточные файлы в тестовой папке: $(ls -la "$TEST_LOG_DIR" | wc -l)"
echo "Созданные архивы:"
ls -la "$BACKUP_DIR"
